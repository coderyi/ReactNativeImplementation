
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>metro · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../cli/cli.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    ReactNative框架的设计与实现
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    第一章 ReactNative的运行时
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../bundle/bundle.html">
            
                <a href="../bundle/bundle.html">
            
                    
                    Native运行时Bundle处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../API/API.html">
            
                <a href="../API/API.html">
            
                    
                    Native API的实现
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../bridge/bridge.html">
            
                <a href="../bridge/bridge.html">
            
                    
                    Bridge
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../JSI/JSI.html">
            
                <a href="../JSI/JSI.html">
            
                    
                    JSI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../AppRegistry/AppRegistry.html">
            
                <a href="../AppRegistry/AppRegistry.html">
            
                    
                    JS侧的AppRegistry
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../timer/timer.html">
            
                <a href="../timer/timer.html">
            
                    
                    Timer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="../interaction/interaction.html">
            
                <a href="../interaction/interaction.html">
            
                    
                    Interaction
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    第二章 ReactNative的包
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.3.1" data-path="metro.html">
            
                <a href="metro.html">
            
                    
                    metro
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../cli/cli.html">
            
                <a href="../cli/cli.html">
            
                    
                    cli
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../sourcemap/sourcemap.html">
            
                <a href="../sourcemap/sourcemap.html">
            
                    
                    sourcemap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    第三章 ReactNative的渲染层
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../view/view.html">
            
                <a href="../view/view.html">
            
                    
                    ReactNative的View
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../render/render.html">
            
                <a href="../render/render.html">
            
                    
                    渲染器
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    第四章 ReactNative的API和组件
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../RCTNetwork/RCTNetwork.html">
            
                <a href="../RCTNetwork/RCTNetwork.html">
            
                    
                    RCTNetwork
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../VirtualizedList/VirtualizedList.html">
            
                <a href="../VirtualizedList/VirtualizedList.html">
            
                    
                    VirtualizedList
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    第五章 常见的三方库
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../CRN/CRN.html">
            
                <a href="../CRN/CRN.html">
            
                    
                    CRN
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../FlashList/FlashList.html">
            
                <a href="../FlashList/FlashList.html">
            
                    
                    RecyclerListView和FlashList
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >metro</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="metro">metro</h1>
<p>metro v0.66.2
react-native-community/cli v6.4.0
mozilla/source-map 0.7.3</p>
<p>Metro&#x6253;&#x5305;&#x5206;&#x4E3A;&#x4E09;&#x4E2A;&#x9636;&#x6BB5;</p>
<ul>
<li>&#x89E3;&#x6790; resolver&#xFF0C;&#x6784;&#x5EFA;&#x56FE;</li>
<li>&#x8F6C;&#x6362; transform&#xFF0C;&#x8F6C;&#x6362;&#x4E3A;&#x76EE;&#x6807;&#x683C;&#x5F0F;</li>
<li>&#x5E8F;&#x5217;&#x5316;</li>
</ul>
<h3 id="metro-api">metro API</h3>
<h4 id="&#x7F16;&#x8BD1;">&#x7F16;&#x8BD1;</h4>
<pre><code>const config = await Metro.loadConfig();

await Metro.runBuild(config, {
  entry: &apos;index.js&apos;,
  platform: &apos;ios&apos;,
  minify: true,
  out: &apos;/Users/Metro/metro-ios.js&apos;
});
</code></pre><p>loadConfig&#x51FD;&#x6570;&#x4E3A;&#x5012;&#x5165;metro.config.js&#x6587;&#x4EF6;&#xFF0C;runBuild&#x5C31;&#x662F;&#x7F16;&#x8BD1;&#xFF0C;&#x8C03;&#x7528;&#x7684;&#x5C31;&#x662F;Server.js&#x7684;build&#x51FD;&#x6570;</p>
<p>&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;sourcemap&#x662F;&#x5185;&#x7F6E;&#xFF0C;&#x8FD8;&#x662F;&#x5206;&#x79BB;&#x51FA;&#x6765;</p>
<h3 id="cli&#x4E2D;metro&#x7684;&#x4F7F;&#x7528;">cli&#x4E2D;metro&#x7684;&#x4F7F;&#x7528;</h3>
<p>&#x6253;&#x5305;&#x547D;&#x4EE4;&#xFF0C;&#x53C2;&#x89C1;<a href="https://github.com/react-native-community/cli/blob/main/packages/cli-plugin-metro/README.md#bundle" target="_blank">&#x6587;&#x6863;</a></p>
<pre><code>npx react-native bundle --entry-file ./index.js --bundle-output AwesomeProject.bundle --minify false
</code></pre><p>metro&#x7684;&#x6253;&#x5305;&#x64CD;&#x4F5C;&#x89C1;buildBundleWithConfig&#x51FD;&#x6570;</p>
<pre><code>    const bundle = await output.build(server, requestOpts);

    await output.save(bundle, args, logger.info);

    // Save the assets of the bundle
    const outputAssets: AssetData[] = await server.getAssets({
      ...Server.DEFAULT_BUNDLE_OPTIONS,
      ...requestOpts,
      bundleType: &apos;todo&apos;,
    });

    // When we&apos;re done saving bundle output and the assets, we&apos;re done.
    return await saveAssets(outputAssets, args.platform, args.assetsDest);
</code></pre><p>output&#x4E24;&#x79CD;&#x6A21;&#x5F0F; metro/src/shared/output/bundle or metro/src/shared/output/RamBundle</p>
<p>&#x5177;&#x4F53;&#x89C1;&#x5BF9;&#x5E94;buildBundle&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x8C03;&#x7528;metro/src/Server.js&#x7684;build&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x662F;&#x6253;&#x5305;&#x7684;&#x6838;&#x5FC3;&#x903B;&#x8F91;</p>
<h3 id="bundle">bundle</h3>
<h4 id="build">build</h4>
<p>Server.js&#x7684;build&#x51FD;&#x6570;</p>
<p>&#x8F93;&#x5165;&#x662F;BundleOptions&#xFF0C;&#x8F93;&#x51FA;&#x662F;bundle code&#x548C;bundle map</p>
<ul>
<li>IncrementalBundler&#x7684;buildGraph&#x51FD;&#x6570;&#xFF0C;&#x8F93;&#x5165;entryfile&#xFF0C;&#x8F93;&#x51FA;graph&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x7684;&#x662F;buildGraphForEntries&#x51FD;&#x6570;&#xFF0C;&#x6700;&#x540E;&#x8C03;&#x7528;&#x7684;&#x662F;DeltaBundler&#x7684;buildGraph&#x51FD;&#x6570;<ul>
<li>DeltaBundler&#x7684;buildGraph&#x4E3B;&#x8981;&#x662F;DeltaCalculator&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x5E76;&#x4E14;&#x8C03;&#x7528;getDelta&#xFF0C;&#x6700;&#x540E;&#x8FD4;&#x56DE;graph</li>
</ul>
</li>
<li>baseJSBundle&#xFF08;&#x8F93;&#x5165;Graph&#xFF0C;&#x8F93;&#x51FA;Bundle&#xFF09;<ul>
<li>processModules&#xFF08;&#x8F93;&#x5165;graph.dependencies.values()&#xFF0C;&#x8F93;&#x51FA;Bundle&#x7684;modules&#xFF09;</li>
</ul>
</li>
<li>bundleToString, Bundle to string,&#x5BF9;&#x4E8E;bundle &#x7684;modules&#x8FDB;&#x884C;&#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;</li>
<li>sourceMapString&#xFF0C;&#x751F;&#x4EA7;sourcemap&#xFF0C;&#x5177;&#x4F53;&#x7684;&#x5B9E;&#x73B0;&#x5728;sourceMapGenerator&#x51FD;&#x6570;<ul>
<li>&#x5148;&#x8C03;&#x7528;&#x5728;sourceMapString.js&#x7684;getSourceMapInfosImpl&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x91CC;&#x4E3B;&#x8981;&#x662F;&#x5BF9;&#x4F20;&#x5165;&#x7684;modules&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;&#xFF0C;&#x5E76;&#x4E14;&#x7EC4;&#x88C5;&#x6210;</li>
<li>&#x7136;&#x540E;&#x8C03;&#x7528;metro-source-map&#x7684;fromRawMappings&#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x5165;raw mappings &#x83B7;&#x5F97;source map</li>
</ul>
</li>
</ul>
<p>buildGraph&#x51FD;&#x6570;&#x90E8;&#x5206;&#xFF0C;&#x8FD9;&#x4E2D;&#x95F4;&#x4F1A;&#x8FDB;&#x884C;resolve&#x548C;transform&#x7684;&#x5904;&#x7406;</p>
<p>&#x5BF9;&#x4E8E;getDelta&#x51FD;&#x6570;&#xFF0C;&#x5B83;&#x4F1A;&#x8C03;&#x7528;_getChangedDependencies&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;initialTraverseDependencies&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x53EF;&#x4EE5;&#x751F;&#x6210;graph.dependencies</p>
<pre><code>async function initialTraverseDependencies&lt;T&gt;(
  graph: Graph&lt;T&gt;,
  options: Options&lt;T&gt;,
): Promise&lt;Result&lt;T&gt;&gt; {
  const delta = {
    added: new Set(),
    modified: new Set(),
    deleted: new Set(),
    inverseDependencies: new Map(),
  };

  const internalOptions = getInternalOptions(options);

  // entryPoints &#x5165;&#x53E3;&#x6587;&#x4EF6; &#x5982;index.js
  // traverseDependenciesForSingleFile&#x8FD9;&#x91CC;&#x8C03;&#x7528; processModule
  await Promise.all(
    graph.entryPoints.map((path: string) =&gt;
      traverseDependenciesForSingleFile(path, graph, delta, internalOptions),
    ),
  );

  reorderGraph(graph, {
    shallow: options.shallow,
  });

  return {
    added: graph.dependencies,
    modified: new Map(),
    deleted: new Set(),
  };
}
</code></pre><p>traverseDependenciesForSingleFile&#x5185;&#x8C03;&#x7528;&#x7684;&#x51FD;&#x6570;&#x662F;processModule&#x3002;</p>
<p>processModule&#x8FD9;&#x4E2A;&#x4F1A;&#x8C03;&#x7528;resolveDependencies&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x8FDB;&#x884C;resolve&#x64CD;&#x4F5C;&#xFF0C;resolve&#x7684;&#x51FD;&#x6570;&#x5728;buildGraph&#x7684;&#x53C2;&#x6570;&#x5185;&#x5B9A;&#x4E49;</p>
<p>processModule&#x4E5F;&#x4F1A;&#x8C03;&#x7528;transform&#xFF0C;transform&#x7684;&#x51FD;&#x6570;&#x5728;buildGraph&#x7684;&#x53C2;&#x6570;&#x5185;&#x5B9A;&#x4E49;</p>
<h5 id="resolve">resolve</h5>
<p>resolve&#x89C1;node-haste/DependencyGraph.js &#x7684; resolveDependency&#x51FD;&#x6570;</p>
<p>resolve&#x7684;&#x662F;&#x5728;buildGraph&#x6D41;&#x7A0B;&#x4E2D;&#x7684;processModule&#x65F6;&#x5019;&#x53D1;&#x8D77;&#x8C03;&#x7528;&#x7684;</p>
<p>resolveDependency &#x7684;&#x5165;&#x53C2; from to&#xFF0C;&#x5206;&#x522B;&#x8868;&#x793A;&#x7ED9;&#x5B9A;&#x8DEF;&#x5F84;&#xFF0C;&#x4EE5;&#x53CA;&#x7ED9;&#x5B9A;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x7684;&#x4F9D;&#x8D56;&#x8DEF;&#x5F84;</p>
<p>&#x4F8B;&#x5982;index.js</p>
<pre><code>import App from &apos;.App&apos;
</code></pre><p>&#x90A3;&#x4E48;from&#x662F;**/index.js&#xFF08;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#xFF09;,to&#x662F;./App</p>
<p>resolveDependency&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x662F;&#x6839;&#x636E;from&#xFF0C;&#x751F;&#x6210;to&#x7684;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x6700;&#x7EC8;&#x5B9E;&#x73B0;&#x5728;metro-resolve&#x7684;resolve.js&#x7684;resolve&#x51FD;&#x6570;</p>
<p><strong>metro config resolver</strong></p>
<p>metro config&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;resolver&#xFF0C;&#x5728;resolve.js&#x91CC;&#x4F1A;&#x8C03;&#x7528;</p>
<pre><code>const defaultResolver = require(&apos;metro-resolver&apos;).resolve;

module.exports = {
  resolver: {
    resolveRequest: (context, moduleName, platform, realModuleName) =&gt; {
      console.log(`log module name ${moduleName}`);
      if (moduleName === &apos;./test&apos;) {
        return {
          filePath: &apos;testDir/test.js&apos;,
          type: &apos;sourceFile&apos;,
        };
      } else {
        return defaultResolver(
          {
            ...context,
            resolveRequest: null,
          },
          moduleName,
          platform,
          realModuleName,
        );
      }
    },
  },
};
</code></pre><h5 id="transform">transform</h5>
<p>processModule&#x91CC;&#x4F1A;&#x8C03;&#x7528;transform&#x51FD;&#x6570;&#xFF0C;&#x7528;&#x4E8E;&#x83B7;&#x53D6;&#x7ED9;&#x5B9A;&#x8DEF;&#x5F84;&#x4E0B;&#x6240;&#x6709;&#x4F9D;&#x8D56;&#xFF0C;&#x4EE5;&#x4FBF;&#x4E4B;&#x540E;&#x9010;&#x4E2A;&#x5BF9;&#x6BCF;&#x4E2A;&#x4F9D;&#x8D56;&#x8FDB;&#x884C;resolve</p>
<p>&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x5728;Bundler.js&#x7684;transformFile&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x8C03;&#x7528;&#x5230;Transformer.js&#x7684;transformFile&#x51FD;&#x6570;&#xFF0C;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x5230;Worker.js&#x7684;transform&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x6839;&#x636E;transformerPath&#x751F;&#x6210;&#x771F;&#x6B63;&#x7684;Transformer&#x3002;</p>
<p>&#x9ED8;&#x8BA4;&#x7684;transformerPath&#x4E3A;metro-transform-worker&#xFF0C;&#x89C1;metro-config/index.js</p>
<h4 id="savebundleandmap">saveBundleAndMap</h4>
<ul>
<li>bundle.code &#x5199;&#x5165;&#x6307;&#x5B9A;&#x8DEF;&#x5F84;</li>
<li>sourcemap(bundle.map)&#x5199;&#x5165;&#x6307;&#x5B9A;&#x8DEF;&#x5F84;&#xFF0C;&#x5148;&#x904D;&#x5386;sourcemap&#x66FF;&#x6362;&#x4E3A;&#x76F8;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x5199;&#x5165;</li>
</ul>
<h3 id="rambundle">RamBundle</h3>
<h4 id="&#x5305;&#x683C;&#x5F0F;">&#x5305;&#x683C;&#x5F0F;</h4>
<p>RamBundle&#x6709;&#x4E24;&#x79CD;&#x6A21;&#x5F0F;</p>
<ul>
<li>Indexed RAM bundle</li>
<li>File RAM bundle</li>
</ul>
<p>&#x903B;&#x8F91;&#x89C1;RamBundle/as-assets.js&#x548C;RamBundle/as-indexed-file.js</p>
<p>Indexed ram bundle &#x7684;&#x683C;&#x5F0F;&#x5982;&#xFF0C;&#x51FA;&#x5904;&#x89C1;<a href="https://metrobundler.dev/docs/bundling" target="_blank">https://metrobundler.dev/docs/bundling</a></p>
<pre><code>` 0                   1                   2                   3                   4                   5                   6
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Magic number                         |                          Header size                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Startup code size                       |                        Module 0 offset                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Module 0 length                        |                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                                               +
|                                                                                                                               |
+                                                              ...                                                              +
|                                                                                                                               |
+                                                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |                        Module n offset                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Module n length                        | Module 0 code | Module 0 code |      ...      |       \0      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Module 1 code | Module 1 code |      ...      |       \0      |                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                                               +
|                                                                                                                               |
+                                                              ...                                                              +
|                                                                                                                               |
+                                                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               | Module n code | Module n code |      ...      |       \0      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+`
</code></pre><p>File RAM bundle</p>
<p>&#x6BCF;&#x4E00;&#x4E2A;&#x6A21;&#x5757;&#x90FD;&#x5B58;&#x50A8;&#x4E3A;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x6587;&#x4EF6;&#x540D;<code>js-modules/${id}.js</code>&#xFF0C;&#x6253;&#x5305;&#x540E;&#x4F1A;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;UNBUNDLE&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x5185;&#x5BB9;&#x4E3A;magic number 0xFB0BD1E5</p>
<h4 id="build">build</h4>
<p>ram bundle &#x7684;build &#x662F;&#x8C03;&#x7528;&#x7684;&#x662F;getRamBundleInfo&#x51FD;&#x6570;&#xFF0C;&#x89C1;RamBundle.js</p>
<pre><code>async function build(packagerClient, requestOptions) {
  const options = {
    ...Server.DEFAULT_BUNDLE_OPTIONS,
    ...requestOptions,
    bundleType: &quot;ram&quot;
  };
  return await packagerClient.getRamBundleInfo(options);
}
</code></pre><p>&#x8FD9;&#x91CC;&#x4F1A;&#x8C03;&#x7528;Server.js &#x7684;getRamBundleInfo&#xFF0C;&#x5148;&#x8C03;&#x7528;buildGraph&#xFF08;&#x540C;bundle&#x4E00;&#x6837;&#x4E5F;&#x662F;IncrementalBundler&#x7684;buildGraph&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;getRamBundleInfo.js&#x7684;getRamBundleInfo</p>
<p>getRamBundleInfo&#x51FD;&#x6570;</p>
<p>&#x8FD9;&#x91CC;&#x4F1A;&#x6839;&#x636E;&#x8F93;&#x5165;&#x7684;pre&#xFF0C;graph.dependencies&#x7B49;&#x7EC4;&#x88C5;modules</p>
<p>&#x6BCF;&#x4E00;&#x4E2A;module&#x7684;module id&#x662F;&#x6839;&#x636E;path &#x8BA1;&#x7B97;&#x7684;&#x81EA;&#x589E;id&#xFF0C;&#x8C03;&#x7528;&#x7684;&#x662F;createModuleId&#x51FD;&#x6570;&#xFF0C;&#x89C1;createModuleIdFactory.js&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x4FDD;&#x5B58;path&#x548C;id&#x7684;&#x6620;&#x5C04;</p>
<p>getRamBundleInfo&#x51FD;&#x6570;&#x6700;&#x540E;&#x4F1A;&#x8FD4;&#x56DE;</p>
<pre><code>export type RamBundleInfo = {|
  getDependencies: string =&gt; Set&lt;string&gt;,
  startupModules: $ReadOnlyArray&lt;ModuleTransportLike&gt;,
  lazyModules: $ReadOnlyArray&lt;ModuleTransportLike&gt;,
  groups: Map&lt;number, Set&lt;number&gt;&gt;,
|};
</code></pre><h4 id="save">save</h4>
<p>ram bundle &#x7684;save&#x51FD;&#x6570;&#x4E3A;saveAsIndexedFile&#xFF0C;saveAsIndexedFile&#x7684;&#x4F5C;&#x7528;&#x662F;&#x4FDD;&#x5B58;&#x6240;&#x6709;&#x7684;JS module&#x4E3A;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x6587;&#x4EF6;&#x5F00;&#x59CB;&#x4E00;&#x4E2A;&#x504F;&#x79FB;&#x8868;&#xFF0C;&#x5305;&#x542B;module id &#x548C;&#x5B83;&#x4EEC;&#x7684;&#x504F;&#x79FB;&#x3002;</p>
<ul>
<li>buildTableAndContents&#xFF0C;&#x6784;&#x5EFA;&#x504F;&#x79FB;&#x8868;&#x548C;&#x5185;&#x5BB9;</li>
<li>buildSourcemapWithMetadata &#x6784;&#x5EFA;sourcemap</li>
<li>writeSourceMap&#xFF0C;&#x5199;sourcemap&#x6587;&#x4EF6;</li>
</ul>
<p>buildTableAndContents&#x4EE3;&#x7801;&#x5982;&#x4E0B;</p>
<pre><code>function buildTableAndContents(
  startupCode: string,
  modules: $ReadOnlyArray&lt;ModuleTransportLike&gt;,
  moduleGroups: ModuleGroups,
  encoding?: &apos;utf8&apos; | &apos;utf16le&apos; | &apos;ascii&apos;,
): Array&lt;Buffer&gt; {
  // file contents layout:
  // - magic number      char[4]  0xE5 0xD1 0x0B 0xFB (0xFB0BD1E5 uint32 LE)
  // - offset table      table    see `buildModuleTables`
  // - code blob         char[]   null-terminated code strings, starting with
  //                              the startup code

  const startupCodeBuffer = nullTerminatedBuffer(startupCode, encoding);
  const moduleBuffers = buildModuleBuffers(modules, moduleGroups, encoding);
  const table = buildModuleTable(
    startupCodeBuffer,
    moduleBuffers,
    moduleGroups,
  );

  return [fileHeader, table, startupCodeBuffer].concat(
    moduleBuffers.map(({buffer}) =&gt; buffer),
  );
}
</code></pre><p>fileHeader&#x7684;&#x5185;&#x5BB9;&#x662F; magic-number.js &#x7684; module.exports = 0xfb0bd1e5;</p>
<p>nullByteBuffer&#x662F;&#x586B;&#x5145;&#x4E86;0</p>
<pre><code>const nullByteBuffer = Buffer.alloc(1).fill(0);
</code></pre><p>nullTerminatedBuffer&#x51FD;&#x6570;&#x7684;&#x4F5C;&#x7528;&#x662F;&#x5728;content&#x540E;&#x62FC;&#x63A5;&#x4E86;nullByteBuffer</p>
<p>buildModuleTable</p>
<pre><code>function buildModuleTable(
  startupCode: Buffer,
  moduleBuffers: Array&lt;{
    buffer: Buffer,
    id: number,
    ...
  }&gt;,
  moduleGroups: ModuleGroups,
): Buffer {
  // table format:
  // - num_entries:      uint_32  number of entries
  // - startup_code_len: uint_32  length of the startup section
  // - entries:          entry...
  //
  // entry:
  //  - module_offset:   uint_32  offset into the modules blob
  //  - module_length:   uint_32  length of the module code in bytes

  const moduleIds = [...moduleGroups.modulesById.keys()];
  const maxId = moduleIds.reduce((max: number, id: number) =&gt;
    Math.max(max, id),
  );
  const numEntries = maxId + 1;
  const table: Buffer = Buffer.alloc(entryOffset(numEntries)).fill(0);

  // num_entries
  table.writeUInt32LE(numEntries, 0);

  // startup_code_len
  table.writeUInt32LE(startupCode.length, SIZEOF_UINT32);

  // entries
  let codeOffset = startupCode.length;
  moduleBuffers.forEach(({id, buffer}) =&gt; {
    const group = moduleGroups.groups.get(id);
    const idsInGroup: Array&lt;number&gt; = group
      ? [id].concat(Array.from(group))
      : [id];

    idsInGroup.forEach((moduleId: number) =&gt; {
      const offset = entryOffset(moduleId);
      // module_offset
      table.writeUInt32LE(codeOffset, offset);
      // module_length
      table.writeUInt32LE(buffer.length, offset + SIZEOF_UINT32);
    });
    codeOffset += buffer.length;
  });

  return table;
}
</code></pre><p>buildSourcemapWithMetadata&#x51FD;&#x6570;&#x89C1;buildSourcemapWithMetadata.js&#x6587;&#x4EF6;&#xFF0C;&#x8C03;&#x7528;combineSourceMapsAddingOffsets&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x901A;&#x8FC7;combineMaps&#x51FD;&#x6570;&#x7EC4;&#x88C5;sections&#xFF0C;combineMaps&#x5185;&#x4F1A;&#x9012;&#x5F52;&#x8C03;&#x7528;combineMaps&#xFF0C;&#x6240;&#x4EE5;&#x6700;&#x7EC8;&#x5F62;&#x6210;&#x7684;map&#x6587;&#x4EF6;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;section&#x5D4C;&#x5957;&#x4E00;&#x4E2A;section</p>
<p>&#x6BCF;&#x4E2A;section&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E3A;</p>
<pre><code>const Section = (line: number, column: number, map: MixedSourceMap) =&gt; ({
  map,
  offset: {line, column},
});
</code></pre><p>android &#x4E0B;&#x9ED8;&#x8BA4;&#x5199;&#x5165;&#x7684;&#x662F;file ram bundle&#xFF0C;&#x5176;&#x4E2D;startupModules&#x5199;&#x5165;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;js&#x6587;&#x4EF6;&#xFF0C;lazyModules&#x5206;&#x522B;&#x5199;&#x5165;js-modules&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;</p>
<p>&#x5728;build&#x7684;&#x65F6;&#x5019;&#xFF0C;module type &#x4E3A; js/script&#x3001;&#x4EE5;&#x53CA;&#x9884;&#x52A0;&#x8F7D;&#x7684;module&#x662F;startupModules&#xFF0C;type&#x4E3A;js/module&#x7684;&#x662F;lazyModules&#x3002;&#x5176;&#x4E2D;&#x9884;&#x52A0;&#x8F7D;&#x7684;module &#x53EF;&#x4EE5;&#x5728;metro.config.js&#x914D;&#x7F6E;</p>
<p>&#x4F8B;&#x5982; &#x5C31;&#x662F;js/script</p>
<pre><code>node_modules/metro-runtime/src/polyfills/require.js
</code></pre><p>&#x8FD9;&#x90E8;&#x5206;&#x4F1A;&#x52A0;&#x5165;getPrependedScripts&#x8FDB;&#x884C;build&#xFF0C;&#x914D;&#x7F6E;&#x5728;metro-config&#x4E0B;&#x7684;defaults.js</p>
<pre><code>exports.moduleSystem = (require.resolve(
  &apos;metro-runtime/src/polyfills/require.js&apos;,
): string);
</code></pre><h3 id="runserver">runServer</h3>
<p>react-native start&#x8C03;&#x7528;&#x7684;&#x5C31;&#x662F;runServer&#x51FD;&#x6570;</p>
<ul>
<li>connect&#x51FD;&#x6570;&#x8C03;&#x7528;</li>
<li>createConnectMiddleware</li>
<li>InspectorProxy &#x521B;&#x5EFA;</li>
<li>createServer</li>
<li>httpServer.listen </li>
</ul>
<h3 id="collectdependenciesjs">collectDependencies.js</h3>
<p>collectDependencies&#x51FD;&#x6570;&#xFF0C;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x5BF9;require&#x548C;import&#x7684;&#x8F6C;&#x6362;&#xFF0C;&#x6BD4;&#x5982; <code>require(&apos;Foo&apos;)</code>&#x4F1A;&#x88AB;&#x8F6C;&#x6362;&#x4E3A;<code>require(_depMap[3], &apos;Foo&apos;)</code>&#xFF0C;<code>_depMap</code> &#x6765;&#x81EA;&#x5916;&#x90E8;&#x4F5C;&#x7528;&#x57DF;&#x3002;</p>
<ul>
<li>&#x6784;&#x9020;visitor<ul>
<li>vistor&#x91CC;CallExpression&#x903B;&#x8F91;&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x8C03;&#x7528;processImportCall&#x6216;processRequireCall</li>
</ul>
</li>
<li>&#x8C03;&#x7528;traverse&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x91CC;&#x8C03;&#x7528;&#x7684;&#x662F;@babel/traverse</li>
</ul>
<h2 id="metro-runtime">metro-runtime</h2>
<p>require.js</p>
<p>&#x8C03;&#x7528;nativeRequire&#x51FD;&#x6570;&#x7684;&#x903B;&#x8F91;</p>
<p>metroRequire-&gt;guardedLoadModule-&gt;loadModuleImplementation-&gt;nativeRequire</p>
<p>metroRequire&#x7684;&#x5165;&#x53C2;&#x4E3A;moduleId&#xFF0C;&#x8FD9;&#x91CC;&#x7684;modules&#x4F1A;&#x5B58;&#x50A8;moduleId &#x548C; module&#x7684;&#x6620;&#x5C04;&#xFF0C;&#x6839;&#x636E;moduleId&#x53D6;&#x51FA;module</p>
<p>loadModuleImplementation&#x7684;&#x5B9E;&#x73B0;</p>
<ul>
<li>&#x5982;&#x679C;&#x5B58;&#x5728;nativeRequire&#xFF0C;&#x5219;&#x8C03;&#x7528;nativeRequire</li>
<li>define&#x5B9A;&#x4E49;&#x7684;function&#x8FDB;&#x884C;&#x8C03;&#x7528;&#xFF0C;&#x8FD9;&#x662F;&#x5173;&#x952E;&#x903B;&#x8F91;</li>
</ul>
<p>define&#xFF0C;&#x4FDD;&#x5B58;moduleId&#x7684;map modules&#xFF0C;&#x5165;&#x53C2;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x4E3A;function&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x4E3A;moduleId&#xFF0C;&#x7B2C;&#x4E09;&#x4E2A;&#x4E3A;&#x4F9D;&#x8D56;&#x7684;moduleId&#x6570;&#x7EC4;</p>
<pre><code>function define(
  factory: FactoryFn,
  moduleId: number,
  dependencyMap?: DependencyMap,
): void {
  const mod: ModuleDefinition = {
    dependencyMap,
    factory,
    hasError: false,
    importedAll: EMPTY,
    importedDefault: EMPTY,
    isInitialized: false,
    publicModule: {exports: {}},
  };
  modules[moduleId] = mod;
}
</code></pre><p>require&#x5F15;&#x7528;&#x7684;&#x6A21;&#x5757;&#x4F1A;&#x88AB;&#x6DFB;&#x52A0;&#x5230;bundle&#x4E2D;&#xFF0C;require&#x7684;&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A;&#x7F16;&#x8BD1;&#x65F6;&#x7684;&#x5E38;&#x91CF;&#xFF08;&#x5176;&#x903B;&#x8F91;&#x89C1;transform&#x91CC;&#x7684;collectDependencies.js&#x5982;&#x4E0B;&#x51FD;&#x6570;&#xFF09;&#x3002;</p>
<pre><code>function getModuleNameFromCallArgs(path: NodePath&lt;CallExpression&gt;): ?string {
  const expectedCount =
    path.node.callee.name === &apos;__conditionallySplitJSResource&apos; ? 2 : 1;
  const args = path.get(&apos;arguments&apos;);
  if (!Array.isArray(args) || args.length !== expectedCount) {
    throw new InvalidRequireCallError(path);
  }

  const result = args[0].evaluate();

  if (result.confident &amp;&amp; typeof result.value === &apos;string&apos;) {
    return result.value;
  }

  return null;
}
</code></pre><h2 id="metro-transform-worker">metro-transform-worker</h2>
<p>transform-&gt;transformJSON / transformAsset / transformJSWithBabel-&gt;transformJS-&gt;collectDependencies</p>
<p>transformJSWithBabel&#xFF0C;&#x5165;&#x53C2;&#x4E3A;file&#xFF0C;&#x542B;&#x6709;file&#x7684;&#x8DEF;&#x5F84;&#xFF0C;&#x5927;&#x5C0F;&#xFF0C;&#x4EE5;&#x53CA;&#x6E90;&#x7801;</p>
<ul>
<li>require metro-react-native-babel-transformer &#xFF0C;&#x521B;&#x5EFA;transform&#xFF0C;&#x5E76;&#x4E14;&#x8C03;&#x7528;transform&#xFF0C;&#x83B7;&#x53D6;ast<ul>
<li>&#x5982;&#x679C;&#x5B58;&#x5728;HermesParser&#xFF0C;&#x5219;&#x8C03;&#x7528;HermesParser&#x7684;parse&#xFF0C;&#x5426;&#x5219;&#x8C03;&#x7528;parseSync&#xFF08;@babel/core&#xFF09;&#xFF0C;&#x6700;&#x540E;&#x4EA7;&#x751F;sourceAst</li>
<li>transformFromAstSync&#xFF08;@babel/core&#xFF09;&#xFF0C;&#x6839;&#x636E;sourceAst&#x4EA7;&#x751F;&#x8FD4;&#x56DE;&#x503C;ast</li>
<li>generateFunctionMap</li>
</ul>
</li>
<li>&#x8C03;&#x7528;transformJS<ul>
<li>collectDependencies&#xFF0C;&#x89C1;worker/collectDependencies.js<ul>
<li>registerDependency&#x51FD;&#x6570;&#xFF0C;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;dependency</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>babel&#x7248;&#x672C;7.21.3</p>
<p>babel&#x662F;&#x4E00;&#x4E2A;JS&#x7F16;&#x8BD1;&#x5668;&#xFF0C;&#x8D1F;&#x8D23;transform&#x3002;</p>
<p>example&#x5982;&#x4E0B;</p>
<pre><code>    const config = {
      ast: true
    }
    const sourceCode = &quot;if (true) console.log(&apos;hello&apos;);&quot;;
    const parsedAst = parseSync(sourceCode, config)
    const transformResult = transformFromAstSync(parsedAst, sourceCode, config);
</code></pre><p>&#x8F93;&#x51FA;&#x7684;result&#x542B;code&#x3001;map&#x3001;ast</p>
<p>code:<code>if(true)return</code></p>
<p>ast</p>
<pre><code>{
    &quot;type&quot;: &quot;File&quot;,
    &quot;start&quot;: 0,
    &quot;end&quot;: 31,
    &quot;loc&quot;: {
        &quot;start&quot;: {
            &quot;line&quot;: 1,
            &quot;column&quot;: 0,
            &quot;index&quot;: 0
        },
        &quot;end&quot;: {
            &quot;line&quot;: 1,
            &quot;column&quot;: 31,
            &quot;index&quot;: 31
        }
    },
    &quot;errors&quot;: [

    ],
    &quot;program&quot;: {
        &quot;type&quot;: &quot;Program&quot;,
        &quot;start&quot;: 0,
        &quot;end&quot;: 31,
        &quot;loc&quot;: {
            &quot;start&quot;: {
                &quot;line&quot;: 1,
                &quot;column&quot;: 0,
                &quot;index&quot;: 0
            },
            &quot;end&quot;: {
                &quot;line&quot;: 1,
                &quot;column&quot;: 31,
                &quot;index&quot;: 31
            }
        },
        &quot;sourceType&quot;: &quot;script&quot;,
        &quot;interpreter&quot;: null,
        &quot;body&quot;: [
            {
                &quot;type&quot;: &quot;IfStatement&quot;,
                &quot;start&quot;: 0,
                &quot;end&quot;: 31,
                &quot;loc&quot;: {
                    &quot;start&quot;: {
                        &quot;line&quot;: 1,
                        &quot;column&quot;: 0,
                        &quot;index&quot;: 0
                    },
                    &quot;end&quot;: {
                        &quot;line&quot;: 1,
                        &quot;column&quot;: 31,
                        &quot;index&quot;: 31
                    }
                },
                &quot;test&quot;: {
                    &quot;type&quot;: &quot;BooleanLiteral&quot;,
                    &quot;start&quot;: 4,
                    &quot;end&quot;: 8,
                    &quot;loc&quot;: {
                        &quot;start&quot;: {
                            &quot;line&quot;: 1,
                            &quot;column&quot;: 4,
                            &quot;index&quot;: 4
                        },
                        &quot;end&quot;: {
                            &quot;line&quot;: 1,
                            &quot;column&quot;: 8,
                            &quot;index&quot;: 8
                        }
                    },
                    &quot;value&quot;: true
                },
                &quot;consequent&quot;: {
                    &quot;type&quot;: &quot;ExpressionStatement&quot;,
                    &quot;start&quot;: 10,
                    &quot;end&quot;: 31,
                    &quot;loc&quot;: {
                        &quot;start&quot;: {
                            &quot;line&quot;: 1,
                            &quot;column&quot;: 10,
                            &quot;index&quot;: 10
                        },
                        &quot;end&quot;: {
                            &quot;line&quot;: 1,
                            &quot;column&quot;: 31,
                            &quot;index&quot;: 31
                        }
                    },
                    &quot;expression&quot;: {
                        &quot;type&quot;: &quot;CallExpression&quot;,
                        &quot;start&quot;: 10,
                        &quot;end&quot;: 30,
                        &quot;loc&quot;: {
                            &quot;start&quot;: {
                                &quot;line&quot;: 1,
                                &quot;column&quot;: 10,
                                &quot;index&quot;: 10
                            },
                            &quot;end&quot;: {
                                &quot;line&quot;: 1,
                                &quot;column&quot;: 30,
                                &quot;index&quot;: 30
                            }
                        },
                        &quot;callee&quot;: {
                            &quot;type&quot;: &quot;MemberExpression&quot;,
                            &quot;start&quot;: 10,
                            &quot;end&quot;: 21,
                            &quot;loc&quot;: {
                                &quot;start&quot;: {
                                    &quot;line&quot;: 1,
                                    &quot;column&quot;: 10,
                                    &quot;index&quot;: 10
                                },
                                &quot;end&quot;: {
                                    &quot;line&quot;: 1,
                                    &quot;column&quot;: 21,
                                    &quot;index&quot;: 21
                                }
                            },
                            &quot;object&quot;: {
                                &quot;type&quot;: &quot;Identifier&quot;,
                                &quot;start&quot;: 10,
                                &quot;end&quot;: 17,
                                &quot;loc&quot;: {
                                    &quot;start&quot;: {
                                        &quot;line&quot;: 1,
                                        &quot;column&quot;: 10,
                                        &quot;index&quot;: 10
                                    },
                                    &quot;end&quot;: {
                                        &quot;line&quot;: 1,
                                        &quot;column&quot;: 17,
                                        &quot;index&quot;: 17
                                    },
                                    &quot;identifierName&quot;: &quot;console&quot;
                                },
                                &quot;name&quot;: &quot;console&quot;
                            },
                            &quot;computed&quot;: false,
                            &quot;property&quot;: {
                                &quot;type&quot;: &quot;Identifier&quot;,
                                &quot;start&quot;: 18,
                                &quot;end&quot;: 21,
                                &quot;loc&quot;: {
                                    &quot;start&quot;: {
                                        &quot;line&quot;: 1,
                                        &quot;column&quot;: 18,
                                        &quot;index&quot;: 18
                                    },
                                    &quot;end&quot;: {
                                        &quot;line&quot;: 1,
                                        &quot;column&quot;: 21,
                                        &quot;index&quot;: 21
                                    },
                                    &quot;identifierName&quot;: &quot;log&quot;
                                },
                                &quot;name&quot;: &quot;log&quot;
                            }
                        },
                        &quot;arguments&quot;: [
                            {
                                &quot;type&quot;: &quot;StringLiteral&quot;,
                                &quot;start&quot;: 22,
                                &quot;end&quot;: 29,
                                &quot;loc&quot;: {
                                    &quot;start&quot;: {
                                        &quot;line&quot;: 1,
                                        &quot;column&quot;: 22,
                                        &quot;index&quot;: 22
                                    },
                                    &quot;end&quot;: {
                                        &quot;line&quot;: 1,
                                        &quot;column&quot;: 29,
                                        &quot;index&quot;: 29
                                    }
                                },
                                &quot;extra&quot;: {
                                    &quot;rawValue&quot;: &quot;hello&quot;,
                                    &quot;raw&quot;: &quot;&apos;hello&apos;&quot;
                                },
                                &quot;value&quot;: &quot;hello&quot;
                            }
                        ],
                        &quot;typeArguments&quot;: null
                    }
                },
                &quot;alternate&quot;: null
            }
        ],
        &quot;directives&quot;: [

        ]
    },
    &quot;comments&quot;: [

    ]
}
</code></pre><p>&#x5177;&#x4F53;ast&#x7684; spec &#x53EF;&#x4EE5;&#x67E5;&#x770B;&#xFF0C;<a href="https://github.com/babel/babel/blob/main/packages/babel-parser/ast/spec.md" target="_blank">https://github.com/babel/babel/blob/main/packages/babel-parser/ast/spec.md</a></p>
<h2 id="metro-transform-plugins">metro-transform-plugins</h2>
<pre><code>type TransformPlugins = {
  addParamsToDefineCall(string, ...Array&lt;mixed&gt;): string,
  constantFoldingPlugin: ConstantFoldingPlugin,
  importExportPlugin: ImportExportPlugin,
  inlinePlugin: InlinePlugin,
  normalizePseudoGlobals: NormalizePseudoGlobalsFn,
  getTransformPluginCacheKeyFiles(): $ReadOnlyArray&lt;string&gt;,
};
</code></pre><p>babel&#x7684;transformFromAstSync&#x51FD;&#x6570;&#x53EF;&#x4EE5;&#x4F20;&#x5165;plugin&#x6570;&#x7EC4;</p>
<p>&#x4E3E;&#x4F8B;&#x4E00;&#x4E2A;&#x6700;&#x7B80;&#x5355;&#x7684;plugin</p>
<pre><code>export default function() {
  return {
    visitor: {
      Identifier(path) {
        const name = path.node.name;
        // reverse the name: JavaScript -&gt; tpircSavaJ
        path.node.name = name
          .split(&quot;&quot;)
          .reverse()
          .join(&quot;&quot;);
      },
    },
  };
}
</code></pre><h2 id="metro-resolver">metro-resolver</h2>
<p>resolve&#x6D41;&#x7A0B;</p>
<ul>
<li>&#x4E3B;&#x8981;&#x8C03;&#x7528;resolveModulePath&#x51FD;&#x6570;<ul>
<li>&#x8C03;&#x7528;redirectModulePath&#xFF0C;&#x83B7;&#x53D6;&#x5230;redirectedPath</li>
<li>&#x8C03;&#x7528;resolveFileOrDir&#xFF0C;&#x62FC;&#x63A5;&#x8DEF;&#x5F84;</li>
</ul>
</li>
<li>&#x5982;&#x679C;&#x662F;allowHaste&#x4E3A;true&#xFF0C;&#x5219;&#x8C03;&#x7528;resolveHasteName&#x51FD;&#x6570;</li>
<li>&#x5982;&#x679C;&#x81EA;&#x5B9A;&#x4E49;resolve&#xFF0C;&#x5219;&#x8C03;&#x7528;resolveRequest</li>
<li>&#x6700;&#x540E;&#x5904;&#x7406;node_modules&#x7684;&#x5185;&#x5BB9;</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="../cli/cli.html" class="navigation navigation-next navigation-unique" aria-label="Next page: cli">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"metro","level":"1.3.1","depth":2,"next":{"title":"cli","level":"1.3.2","depth":2,"path":"article/cli/cli.md","ref":"article/cli/cli.md","articles":[]},"previous":{"title":"第二章 ReactNative的包","level":"1.3","depth":1,"ref":"","articles":[{"title":"metro","level":"1.3.1","depth":2,"path":"article/metro/metro.md","ref":"article/metro/metro.md","articles":[]},{"title":"cli","level":"1.3.2","depth":2,"path":"article/cli/cli.md","ref":"article/cli/cli.md","articles":[]},{"title":"sourcemap","level":"1.3.3","depth":2,"path":"article/sourcemap/sourcemap.md","ref":"article/sourcemap/sourcemap.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"article/metro/metro.md","mtime":"2025-08-01T16:37:16.874Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2025-09-24T13:00:58.082Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

